name: Weather ETL Pipeline

on:
  schedule:
    - cron: "0 * * * *"   # toutes les heures
  workflow_dispatch:      # bouton "Run"

jobs:
  etl:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: First_Data
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -u root -p$${MYSQL_ROOT_PASSWORD}" --health-interval=10s --health-timeout=5s --health-retries=10

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîÅ Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üõ†Ô∏è Install system deps (mysql client)
        run: |
          sudo apt-get update && sudo apt-get install -y default-mysql-client

      - name: üì¶ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ‚è≥ Wait for MySQL service
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
        run: |
          for i in {1..60}; do
            if mysql -h mysql -u root -p"$MYSQL_ROOT_PASSWORD" -e "SELECT 1" >/dev/null 2>&1; then
              echo "MySQL ready"
              exit 0
            fi
            echo "Waiting for MySQL... ($i)"
            sleep 2
          done
          echo "MySQL did not become ready" && exit 1

      - name: ‚ÑπÔ∏è Print DB env (non-secret)
        env:
          DB_USER: root
          DB_HOST: mysql
          DB_NAME: First_Data
        run: |
          echo "DB_USER=$DB_USER"
          echo "DB_HOST=$DB_HOST"
          echo "DB_NAME=$DB_NAME"

      - name: üî¨ Test DB connection (SQLAlchemy)
        env:
          DB_USER: root
          DB_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          DB_HOST: mysql
          DB_NAME: First_Data
        run: |
          python - <<'PY'
          import os, traceback
          from sqlalchemy import create_engine

          user = os.environ.get('DB_USER')
          pwd = os.environ.get('DB_PASSWORD')
          host = os.environ.get('DB_HOST')
          name = os.environ.get('DB_NAME')

          print('Try connect to:', user, host, name)
          try:
              engine = create_engine(f"mysql+pymysql://{user}:{pwd}@{host}/{name}")
              conn = engine.connect()
              print('SQLAlchemy: connection OK')
              conn.close()
          except Exception:
              traceback.print_exc()
              raise
          PY

      - name: üöÄ Run ETL pipeline
        env:
          API_KEY: ${{ secrets.API_KEY }}
          DB_USER: root
          DB_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          DB_HOST: mysql
          DB_NAME: First_Data
        run: |
          python main.py
